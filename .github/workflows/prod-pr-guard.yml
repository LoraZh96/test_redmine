name: Validate Prod PR

on:
  pull_request:
    branches:
      - prod
  workflow_dispatch:

permissions:
  pull-requests: read
  contents: write

jobs:
  guard_prod_pr:
    if: github.event_name == 'pull_request'
    name: Vérifications PR prod
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    steps:
      - name: Ensure head branch is main
        id: check-branch
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const headBranch = context.payload.pull_request.head.ref
            if (headBranch !== 'main') {
              core.setFailed(`PR vers prod depuis ${headBranch}. Seules les fusions depuis main sont autorisées.`)
            } else {
              core.info('Head branch is main.')
            }

      - name: Ensure PR approved by a human reviewer
        if: steps.check-branch.conclusion == 'success'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo
            const pull_number = context.payload.pull_request.number

            const reviews = await github.paginate(
              github.rest.pulls.listReviews,
              { owner, repo, pull_number, per_page: 100 }
            )

            const finalStates = new Map()

            for (const review of reviews) {
              if (!review.user || review.user.type !== 'User' || review.user.login.endsWith('[bot]')) {
                continue
              }
              finalStates.set(review.user.login, review.state)
            }

            const hasHumanApproval = Array.from(finalStates.values()).some((state) => state === 'APPROVED')

            if (!hasHumanApproval) {
              core.setFailed('Aucune approbation humaine active détectée pour cette PR.')
            } else {
              core.info('Au moins une approbation humaine est active.')
            }

  manual_merge:
    if: github.event_name == 'workflow_dispatch'
    name: Mise en prod
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Merge main into prod
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo
            try {
              const merge = await github.rest.repos.merge({
                owner,
                repo,
                base: 'prod',
                head: 'main',
                commit_message: 'Mise en prod: merge main -> prod'
              })
              core.info(`Merge effectué: ${merge.sha}`)
            } catch (error) {
              if (error.status === 409) {
                core.setFailed('Merge impossible: conflits entre main et prod.')
              } else {
                throw error
              }
            }
