---
# ==============================================================
# PLAYBOOK GLOBAL — déploiement complet de l’infrastructure
# ==============================================================
# Configuration des serveurs
# ==============================================================

- name: Configurer le bastion
  hosts: bastion
  become: yes
  vars_files:
    - group_vars/bastion.yml
  roles:
    - bastion

- import_playbook: playbooks/update_dns.yml
  tags: [dns]

- name: Attendre la propagation DNS (90 secondes)
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Pause pour propagation DNS
      ansible.builtin.pause:
        seconds: 90
        prompt: "Attente de la propagation DNS..."
  tags: [dns]

- name: Configurer le proxy (Nginx + WAF + Fail2ban)
  hosts: proxy
  become: yes
  roles:
    - proxy

- name: Installer Docker sur tous les nœuds
  hosts: manager,workers,monitoring
  become: yes
  roles:
    - docker

- name: Initialiser le cluster Docker Swarm
  hosts: manager,workers
  become: yes
  roles:
    - docker-swarm

- name: Déployer le monitoring (Prometheus + Grafana + Alertmanager)
  hosts: monitoring
  become: yes
  roles:
    - monitoring

- name: Déployer Node Exporter sur tous les serveurs
  hosts: all:!fck_nat
  become: yes
  roles:
    - node-exporter

- name: Déployer Redmine (application + secrets + stack Docker)
  hosts: manager
  become: yes
  roles:
    - redmine-app