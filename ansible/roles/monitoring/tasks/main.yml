---
- name: Configuration du monitoring
  become: yes
  block:
    # NETTOYAGE ET PRÉPARATION
    - name: Vérifier et réparer dpkg
      shell: |
        dpkg --configure -a
        apt-get update --fix-missing
      changed_when: false
      ignore_errors: yes

    - name: Nettoyer les paquets cassés
      apt:
        autoremove: yes
        autoclean: yes

    - name: Mettre à jour le cache APT
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: S'assurer que Docker est démarré
      systemd:
        name: docker
        state: started
        enabled: yes

    # CRÉATION DES RÉPERTOIRES
    - name: Vérifier si /opt existe
      stat:
        path: /opt
      register: opt_exists
      become: yes

    - name: Afficher le résultat
      debug:
        msg: "/opt existe: {{ opt_exists.stat.exists }}"
    - name: Créer le répertoire /opt si nécessaire
      file:
        path: /opt
        state: directory
        owner: root
        group: root
        mode: '0755'
      when: not opt_exists.stat.exists

    - name: Créer le répertoire de monitoring
      file:
        path: /opt/monitoring
        state: directory
        owner: root
        group: root
        mode: '0755'
      register: monitoring_dir

    - name: Vérifier que le répertoire a été créé
      debug:
        msg: "Répertoire monitoring créé: {{ monitoring_dir.changed }}"

    # DÉPLOIEMENT DES CONFIGURATIONS
    - name: Copier la configuration Prometheus
      template:
        src: prometheus.yml.j2
        dest: /opt/monitoring/prometheus.yml
        mode: '0644'
      notify: restart monitoring stack

    - name: Copier les règles d'alertes Prometheus
      template:
        src: alert.rules.yml.j2
        dest: /opt/monitoring/alert.rules.yml
        mode: '0644'
      notify: restart monitoring stack

    - name: Copier la configuration Grafana datasource
      template:
        src: grafana-datasource.yml.j2
        dest: /opt/monitoring/grafana-datasource.yml
        mode: '0644'
      notify: restart monitoring stack


    - name: Copier la configuration Alertmanager
      template:
        src: alertmanager.yml.j2
        dest: /opt/monitoring/alertmanager.yml
        mode: '0644'
      notify: restart monitoring stack

    - name: Copier les règles d'alertes Prometheus
      template:
        src: alert.rules.yml.j2
        dest: /opt/monitoring/alert.rules.yml
        mode: '0644'
      notify: restart monitoring stack

    - name: Copier la configuration Docker Compose du monitoring
      template:
        src: docker-compose.yml.j2
        dest: /opt/monitoring/docker-compose.yml
        mode: '0644'
      notify: restart monitoring stack

    # CRÉATION DES SECRETS TELEGRAM POUR ALERTMANAGER
    - name: Créer les secrets Docker Swarm pour Alertmanager (Telegram)
      shell: |
        SECRET_NAME="{{ item.name }}"
        SECRET_VALUE="{{ item.value }}"
        if ! docker secret ls --format '{{"{{.Name}}"}}' | grep -q "^${SECRET_NAME}$"; then
          echo "${SECRET_VALUE}" | docker secret create ${SECRET_NAME} -
        fi
      loop:
        - { name: "TELEGRAM_BOT_TOKEN", value: "{{ lookup('env', 'TELEGRAM_BOT_TOKEN') | default('', true) }}" }
        - { name: "TELEGRAM_CHAT_ID",   value: "{{ lookup('env', 'TELEGRAM_CHAT_ID') | default('', true) }}" }
      args:
        executable: /bin/bash
      no_log: true
      when:
        - lookup('env', 'TELEGRAM_BOT_TOKEN') | length > 0
        - lookup('env', 'TELEGRAM_CHAT_ID') | length > 0  

    # GESTION DE LA STACK
    - name: Arrêter la stack existante si config modifiée
      shell: docker compose down
      args:
        chdir: /opt/monitoring
      #when: docker_compose_config is changed
      ignore_errors: yes

    - name: Lancer la stack de monitoring
      shell: docker compose up -d
      args:
        chdir: /opt/monitoring
      register: compose_up

   # - name: Afficher le résultat du démarrage
     # debug:
       # var: compose_up.stdout_lines

    # VÉRIFICATIONS
    - name: Attendre le démarrage des conteneurs
      pause:
        seconds: 10

    - name: Lister les conteneurs de la stack
      shell: docker compose ps
      args:
        chdir: /opt/monitoring
      register: compose_ps
      changed_when: false
      failed_when: false

    - name: Afficher l'état des conteneurs
      debug:
        var: compose_ps.stdout_lines

    - name: Vérifier que Prometheus fonctionne
      uri:
        url: "http://localhost:9090/-/healthy"
        method: GET
        status_code: 200
      register: prometheus_health
      retries: 10
      delay: 5
      until: prometheus_health.status == 200
      failed_when: false

    - name: Afficher le statut de Prometheus
      debug:
        msg: "{{ 'OK' if prometheus_health.status == 200 else 'ÉCHEC' }}"

    - name: Vérifier que Grafana fonctionne
      uri:
        url: "http://localhost:3000/api/health"
        method: GET
        status_code: 200
      register: grafana_health
      retries: 10
      delay: 5
      until: grafana_health.status == 200
      failed_when: false

    - name: Afficher le statut de Grafana
      debug:
        msg: "{{ 'OK' if grafana_health.status == 200 else 'ÉCHEC' }}"

    - name: Vérifier que Alertmanager fonctionne
      uri:
        url: "http://localhost:9093/-/healthy"
        method: GET
        status_code: 200
      register: alertmanager_health
      retries: 10
      delay: 5
      until: alertmanager_health.status == 200
      failed_when: false

    - name: Afficher le statut d'Alertmanager
      debug:
        msg: "{{ 'OK' if alertmanager_health.status == 200 else 'ÉCHEC' }}"

     # IMPORTATION AUTOMATIQUE D'UN DASHBOARD GRAFANA
    - name: Télécharger les dashboards Grafana depuis grafana.com
      uri:
        url: "https://grafana.com/api/dashboards/{{ item.id }}/revisions/latest/download"
        method: GET
        return_content: yes
      register: grafana_dashboards
      loop:
        - { id: 1860 } # Node Exporter Full
        - { id: 14282 }  # Docker and Container Monitoring (cAdvisor)
      retries: 3
      delay: 3
      when: grafana_health.status == 200

    - name: Importer les dashboards Grafana dans l'instance locale
      uri:
        url: "http://localhost:3000/api/dashboards/import"
        method: POST
        user: admin
        password: admin
        force_basic_auth: yes
        body_format: json
        body: |
          {
            "dashboard": {{ (grafana_dashboards.results
              | selectattr('item.id', 'equalto', item.id)
              | first).content
              | from_json
              | to_json }},
           "overwrite": true,
           "inputs": [
              {
                "name": "DS_PROMETHEUS",
                "type": "datasource",
                "pluginId": "prometheus",
                "value": "Prometheus"
              },
              {
                "name": "DS_THEMIS",
                "type": "datasource",
                "pluginId": "prometheus",
                "value": "Prometheus"
              }
            ],
            "folderId": 0
          }
        status_code: 200
      loop:
        - { id: 1860 }
        - { id: 14282 } 
      when: grafana_health.status == 200
      register: grafana_import
      retries: 5
      delay: 5
      until: grafana_import.status == 200
      tags: grafana

    - name: Afficher le résultat de l'importation des dashboards
      debug:
        msg: "✅ Dashboards Grafana importés avec succès."
      when: grafana_import is succeeded


    # INFORMATIONS FINALES
    - name: Afficher les URLs d'accès
      debug:
        msg:
          - "=========================================="
          - "✅ Stack monitoring déployée"
          - "=========================================="
          - ""
          - "Accès local (sur le serveur monitoring):"
          - "  Prometheus:    http://localhost:9090"
          - "  Grafana:       http://localhost:3000 (admin/admin)"
          - "  Alertmanager:  http://localhost:9093"
          - ""
          - "Accès depuis le proxy (IP interne):"
          - "  Prometheus:    http://{{ hostvars['monitoring'].ansible_host }}:9090"
          - "  Grafana:       http://{{ hostvars['monitoring'].ansible_host }}:3000"
          - "  Alertmanager:  http://{{ hostvars['monitoring'].ansible_host }}:9093"
          - ""
          - "Accès depuis Internet (via Nginx):"
          - "  Prometheus:    https://ficus-prometheus.duckdns.org"
          - "  Grafana:       https://ficus-grafana.duckdns.org"
          - ""
          - "=========================================="

    - name: Afficher les logs en cas d'échec
      shell: docker compose logs --tail=50
      args:
        chdir: /opt/monitoring
      register: compose_logs
      changed_when: false
      when: 
        - prometheus_health.status|default(0) != 200 or 
          grafana_health.status|default(0) != 200 or 
          alertmanager_health.status|default(0) != 200

    - name: Afficher les logs
      debug:
        var: compose_logs.stdout_lines
      when: compose_logs.stdout_lines is defined

    - name: Récupérer la configuration Telegram depuis l'environnement
      set_fact:
        telegram_bot_token_env: "{{ lookup('env', 'TELEGRAM_BOT_TOKEN') | default('', true) }}"
        telegram_chat_id_env: "{{ lookup('env', 'TELEGRAM_CHAT_ID') | default('', true) }}"
      no_log: true

    - name: Envoyer un message de confirmation à Telegram
      uri:
        url: "https://api.telegram.org/bot{{ telegram_bot_token_env }}/sendMessage"
        method: POST
        body_format: form-urlencoded
        body:
          chat_id: "{{ telegram_chat_id_env }}"
          text: "✅ Déploiement du monitoring terminé avec succès !"
      register: telegram_test
      retries: 3
      delay: 5
      until: telegram_test.status == 200
      when:
        - telegram_bot_token_env | length > 0
        - telegram_chat_id_env | length > 0
      no_log: true
