global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'node_exporter'
    static_configs:
      - targets:
          - '{{ hostvars['bastion'].private_ip }}:9100'
          - '{{ hostvars['proxy'].private_ip }}:9100'
          - '{{ hostvars['manager'].ansible_host }}:9100'
          - '{{ hostvars['worker1'].ansible_host }}:9100'
          - '{{ hostvars['worker2'].ansible_host }}:9100'
          - '{{ hostvars['monitoring'].ansible_host }}:9100'

  - job_name: 'cadvisor'
    metrics_path: /metrics
    scheme: http
    static_configs:
{% set cadvisor_hosts = (groups['manager'] | default([])) + (groups['workers'] | default([])) %}
{% if cadvisor_hosts %}
      - targets:
{% for host in cadvisor_hosts %}
          - "{{ (hostvars[host].private_ip | default(hostvars[host].ansible_host)) }}:8080"
{% endfor %}
{% else %}
      - targets: []
{% endif %}

alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - "alertmanager:9093"

rule_files:
  - "/etc/prometheus/alert.rules.yml"

